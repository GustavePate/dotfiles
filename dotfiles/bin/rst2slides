#!/bin/bash

rst2slides(){

    PUB=0

    if [ $# -eq 3 ]; then
        echo "publish"
        PUB=1
        if [ -d ~/webshare_me/public ];then
            PUB=1
        else
            mount ~/webshare_me
            if [ $? -ne 0 ]; then
                echo "ERROR webshare non montÃ©"
            fi
        fi
    fi

    echo "rst2slides doc.rst (~/pub/)name(.html) [pub]"
    CUR_PATH=`pwd`


    # cp $1 ~/pub/src
    BASE=`basename $CUR_PATH`
    echo "construction de $1 du repertoire $BASE"

    cp -r ../$BASE ~/pub/src/

    if [ $PUB -eq 1 ];then
        cp -r ../$BASE ~/webshare_me/public/guillaume/src/$BASE
    fi

    cd ~/pub
    sed -e "s/\(\.\.\ image::\ \)ressources/\1src\/$BASE\/ressources/" ./src/$BASE/$1 > ./src/tmp1.rst
    sed -e "s/\(\.\.\ figure::\ \)ressources/\1src\/$BASE\/ressources/" ./src/tmp1.rst > ./src/tmp.rst


    if [ $PUB -eq 0 ];then
        echo "regular"
        pandoc -f rst -t dzslides ./src/tmp.rst -o ~/pub/tmp.html \
            --mathml \
            --css ./dzslides/fonts.css \
            --css ./dzslides/prism.css \
            --css ./dzslides/template.css \
            --slide-level=2 \
            --template ./dzslides/dz_template.html
    else
        echo "self contained"
        pandoc -f rst -t dzslides ./src/tmp.rst -o ~/pub/tmp.html \
            --mathml \
            --css ./dzslides/fonts.css \
            --css ./dzslides/prism.css \
            --css ./dzslides/template.css \
            --template ./dzslides/dz_template.html \
            --slide-level=2 \
            --self-contained
    fi

    sed -e 's/sourceCode\ \(\w\+\)/sourceCode\ language-\1/' ~/pub/tmp.html > ~/pub/$2.html

    if [ $PUB -eq 1 ];then
        cp ~/pub/$2.html ~/webshare_me/public/guillaume/
        cp -r ~/pub/dzslides ~/webshare_me/public/guillaume/
    fi

    cd $CUR_PATH
}

PUBLISH=0

while getopts ":c:pi:o:" opt; do
    case $opt in
    p)
        echo "publish mode" >&2
        PUBLISH=1
        ;;
    i)
        echo "input set to: "$OPTARG >&2
        INPUT=$OPTARG
        ;;
    o)
        echo "output set to: "$OPTARG >&2
        OUTPUT=$OPTARG
        ;;
    c)
        echo "css set to "$OPTARG
        CSS=$OPTARG
    esac
done

rst2slides $INPUT $OUTPUT $PUBLISH $CSS

